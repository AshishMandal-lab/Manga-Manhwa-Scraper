<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ gallery_name }}</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
        
        :root {
            --accent-primary: #bb9af7;
            --bg-color: #0b0d12;
            --text-heading: #ffffff;
            --panel-bg: rgba(26, 27, 38, 0.95);
            --border-color: rgba(192, 202, 245, 0.2);
        }

        html, body {
            position: relative;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-color);
            font-family: 'Poppins', sans-serif;
            color: var(--text-heading);
            overflow: hidden;
        }

        /* --- View Containers --- */
        .view-container {
            width: 100%;
            height: 100%;
        }
        
        /* --- Carousel (Swiper) View --- */
        .swiper-view {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .swiper {
            width: 100%;
            height: 100%;
        }
        .swiper-slide {
            background-position: center;
            background-size: cover;
            width: 400px;
            height: 600px;
            -webkit-box-reflect: below 1px linear-gradient(transparent, transparent, #0006);
            cursor: pointer;
            background-color: #000;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .swiper-slide img, .swiper-slide video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        /* --- Vertical View --- */
        .vertical-view {
            display: none;
            overflow-y: auto;
            padding: 80px 0;
            box-sizing: border-box;
            text-align: center;
        }
        .vertical-media {
            display: block;
            max-width: 85vw;
            max-height: 90vh;
            margin: 0 auto 2rem auto;
            border-radius: 8px;
            cursor: pointer;
            background-color: #000;
        }

        /* --- UI Buttons --- */
        .ui-button {
            position: fixed;
            z-index: 1002;
            background-color: var(--panel-bg);
            color: var(--text-heading);
            border: 1px solid var(--border-color);
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            text-decoration: none;
        }
        .ui-button:hover {
            background-color: var(--accent-primary);
            color: var(--bg-color);
            transform: scale(1.1);
        }
        
        .back-button {
            top: 20px;
            left: 20px;
            border-radius: 50%;
        }

        #layoutToggle {
            top: 20px;
            left: 80px;
            border-radius: 8px;
        }

        /* --- Lightbox Styles --- */
        .lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .lightbox.active { opacity: 1; visibility: visible; }
        .lightbox-content img, .lightbox-content video {
            max-width: 95vw; max-height: 95vh; display: block; object-fit: contain;
        }
        .lightbox-close {
            position: absolute; top: 20px; right: 20px; z-index: 2001;
            background-color: var(--panel-bg); color: var(--text-heading);
            border: 1px solid var(--border-color); border-radius: 50%; width: 40px;
            height: 40px; display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; cursor: pointer;
        }
    </style>
</head>
<body>
    
    <a href="{{ url_for('gallery') }}" class="ui-button back-button" title="Back to Gallery">&larr;</a>
    <button class="ui-button" id="layoutToggle" title="Switch View">â†•</button>
    
    <div class="view-container swiper-view" id="swiperView">
        <div class="swiper">
            <div class="swiper-wrapper">
                {% for media in media_files %}
                    <div class="swiper-slide" data-type="{{ media.type }}" data-full-src="{{ media.url }}">
                        {% if media.type == 'image' %}
                            <img src="{{ media.url }}" alt="Image {{ loop.index }}" loading="lazy" />
                        {% elif media.type == 'video' %}
                            <video src="{{ media.url }}" muted loop playsinline></video>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <div class="swiper-pagination"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </div>

    <div class="view-container vertical-view" id="verticalView">
        </div>

    <div class="lightbox" id="fullscreenLightbox">
        <button class="lightbox-close" aria-label="Close Fullscreen View">&times;</button>
        <div class="lightbox-content" id="lightboxContent"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script>
        // --- Element References ---
        const layoutToggle = document.getElementById('layoutToggle');
        const swiperView = document.getElementById('swiperView');
        const verticalView = document.getElementById('verticalView');
        let isVerticalView = false;

        // --- Swiper Initialization ---
        const swiper = new Swiper('.swiper', {
            effect: 'coverflow', grabCursor: true, centeredSlides: true, slidesPerView: 'auto',
            coverflowEffect: { rotate: 50, stretch: 0, depth: 100, modifier: 1, slideShadows: true, },
            loop: false, pagination: { el: '.swiper-pagination', clickable: true },
            navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
            keyboard: { enabled: true }, mousewheel: true,
        });

        // --- Lightbox Logic ---
        const lightbox = document.getElementById('fullscreenLightbox');
        const lightboxContent = document.getElementById('lightboxContent');
        const lightboxCloseBtn = document.querySelector('.lightbox-close');
        function openLightbox(mediaType, mediaSrc) {
            lightboxContent.innerHTML = '';
            if (mediaType === 'image') {
                const img = document.createElement('img');
                img.src = mediaSrc;
                lightboxContent.appendChild(img);
            } else if (mediaType === 'video') {
                const vid = document.createElement('video');
                vid.src = mediaSrc;
                vid.controls = true;
                vid.autoplay = true;
                lightboxContent.appendChild(vid);
            }
            lightbox.classList.add('active');
        }
        function closeLightbox() {
            lightbox.classList.remove('active');
            lightboxContent.innerHTML = '';
        }
        lightboxCloseBtn.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => (e.target === lightbox) && closeLightbox());
        document.addEventListener('keydown', (e) => (e.key === 'Escape') && closeLightbox());

        // --- Populate Vertical View and Add Lightbox Clicks ---
        const mediaData = {{ media_files | tojson }};
        mediaData.forEach(media => {
            let mediaElement;
            if (media.type === 'image') { mediaElement = document.createElement('img'); } 
            else if (media.type === 'video') {
                mediaElement = document.createElement('video');
                mediaElement.muted = true; mediaElement.autoplay = true;
                mediaElement.loop = true; mediaElement.playsinline = true;
            }
            mediaElement.src = media.url;
            mediaElement.className = 'vertical-media';
            mediaElement.loading = 'lazy';
            mediaElement.addEventListener('click', () => openLightbox(media.type, media.url));
            verticalView.appendChild(mediaElement);
        });
        swiper.slides.forEach(slide => {
            slide.addEventListener('click', () => {
                if (slide.classList.contains('swiper-slide-active')) {
                    openLightbox(slide.dataset.type, slide.dataset.fullSrc);
                }
            });
        });

        // --- Layout Toggle Logic ---
        layoutToggle.addEventListener('click', () => {
            isVerticalView = !isVerticalView;
            if (isVerticalView) {
                swiperView.style.display = 'none';
                verticalView.style.display = 'block';
                layoutToggle.innerHTML = '&#9638;'; // Switch icon to squares
                layoutToggle.title = 'Switch to Carousel View';
            } else {
                verticalView.style.display = 'none';
                swiperView.style.display = 'flex';
                swiper.update(); // Important: tell swiper to recalculate its size
                layoutToggle.innerHTML = '&#8597;'; // Switch icon to up/down arrow
                layoutToggle.title = 'Switch to Vertical View';
            }
        });
    </script>
</body>
</html>